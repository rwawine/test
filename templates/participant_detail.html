{% extends "base.html" %}

{% block title %}{{ participant.full_name }} - –£—á–∞—Å—Ç–Ω–∏–∫{% endblock %}

{% block content %}
<div class="pb-2 mb-6 border-b border-gray-200">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">{{ participant.full_name }}</h1>
            <p class="text-sm text-gray-500">–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—á–∞—Å—Ç–Ω–∏–∫–µ</p>
        </div>
        <a href="{{ url_for('main.participants') }}" class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50">
            <i class="fa-solid fa-arrow-left mr-2"></i>–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
        </a>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-8">
        <!-- Participant Information -->
        <div class="bg-white shadow overflow-hidden sm:rounded-lg">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <h3 class="text-lg leading-6 font-medium text-gray-900">
                    <i class="fa-solid fa-user-circle mr-2 text-gray-500"></i>
                    –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                </h3>
            </div>
            <div class="px-4 py-5 sm:p-6">
                <dl class="grid grid-cols-1 gap-x-4 gap-y-8 sm:grid-cols-2">
                    <div class="sm:col-span-1">
                        <dt class="text-sm font-medium text-gray-500">–ü–æ–ª–Ω–æ–µ –∏–º—è</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ participant.full_name }}</dd>
                    </div>
                    <div class="sm:col-span-1">
                        <dt class="text-sm font-medium text-gray-500">–¢–µ–ª–µ—Ñ–æ–Ω</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ participant.phone_number }}</dd>
                    </div>
                    <div class="sm:col-span-1">
                        <dt class="text-sm font-medium text-gray-500">Telegram</dt>
                        <dd class="mt-1 text-sm text-gray-900">
                            {% if participant.username %}@{{ participant.username }}{% else %}-{% endif %}
                            <span class="text-xs text-gray-400"> (ID: {{ participant.telegram_id }})</span>
                        </dd>
                    </div>
                    <div class="sm:col-span-1">
                        <dt class="text-sm font-medium text-gray-500">–ö–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ participant.loyalty_card }}</dd>
                    </div>
                    <div class="sm:col-span-1">
                        <dt class="text-sm font-medium text-gray-500">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ participant.registration_date.strftime('%d.%m.%Y %H:%M') if participant.registration_date else 'N/A' }}</dd>
                    </div>
                    <div class="sm:col-span-1">
                        <dt class="text-sm font-medium text-gray-500">–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å</dt>
                        <dd class="mt-1 text-sm text-gray-900">
                            {% if participant.status == 'approved' %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">–û–¥–æ–±—Ä–µ–Ω–æ</span>
                            {% elif participant.status == 'pending' %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</span>
                            {% elif participant.status == 'rejected' %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>
                            {% endif %}
                        </dd>
                    </div>
                    {% if participant.admin_notes %}
                    <div class="sm:col-span-2">
                        <dt class="text-sm font-medium text-gray-500">–ó–∞–º–µ—Ç–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</dt>
                        <dd class="mt-1 text-sm text-gray-900 bg-gray-50 p-3 rounded-md">{{ participant.admin_notes }}</dd>
                    </div>
                    {% endif %}
                </dl>
            </div>
        </div>

        <!-- Leaflet Photo -->
        {% if participant.leaflet_photo_path %}
        <div class="bg-white shadow overflow-hidden sm:rounded-lg">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <h3 class="text-lg leading-6 font-medium text-gray-900">
                    <i class="fa-solid fa-image mr-2 text-gray-500"></i>
                    –§–æ—Ç–æ –ª–∏—Ñ–ª–µ—Ç–∞
                </h3>
            </div>
            <div class="px-4 py-5 sm:p-6 text-center">
                <img src="{{ url_for('static', filename=participant.leaflet_photo_path) }}" alt="–§–æ—Ç–æ –ª–∏—Ñ–ª–µ—Ç–∞" class="max-w-full h-auto max-h-96 mx-auto rounded-lg shadow-md">
                <a href="{{ url_for('static', filename=participant.leaflet_photo_path) }}" target="_blank" class="mt-4 inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    <i class="fa-solid fa-external-link-alt mr-2"></i>–û—Ç–∫—Ä—ã—Ç—å –≤ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ
                </a>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Actions Panel -->
    <div class="lg:col-span-1 space-y-8">
        <div class="bg-white shadow sm:rounded-lg">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <h3 class="text-lg leading-6 font-medium text-gray-900">
                    <i class="fa-solid fa-cogs mr-2 text-gray-500"></i>
                    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–º
                </h3>
            </div>
            <div class="px-4 py-5 sm:p-6">
                <form method="POST" action="{{ url_for('main.update_participant_status', participant_id=participant.id) }}" x-data="{ status: '{{ participant.status }}' }">
                    <div class="space-y-6">
                        <div>
                            <label for="status" class="block text-sm font-medium text-gray-700">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</label>
                            <select id="status" name="status" x-model="status" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-gray-500 focus:border-gray-500 sm:text-sm rounded-md">
                                <option value="pending">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</option>
                                <option value="approved">–û–¥–æ–±—Ä–∏—Ç—å</option>
                                <option value="rejected">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</option>
                            </select>
                        </div>

                        <div>
                            <label for="notes" class="block text-sm font-medium text-gray-700">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–∞</label>
                            <textarea id="notes" name="notes" rows="4" class="mt-1 shadow-sm focus:ring-gray-500 focus:border-gray-500 block w-full sm:text-sm border border-gray-300 rounded-md" placeholder="–≠—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram...">{{ participant.admin_notes or '' }}</textarea>
                        </div>

                        <div x-show="status === 'rejected'" x-transition class="space-y-2">
                            <p class="text-sm font-medium text-gray-700">–®–∞–±–ª–æ–Ω—ã –ø—Ä–∏—á–∏–Ω –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è:</p>
                            <div class="grid grid-cols-2 gap-2">
                                <button type="button" @click="document.getElementById('notes').value = '–ù–µ—á–µ—Ç–∫–æ–µ —Ñ–æ—Ç–æ –ª–∏—Ñ–ª–µ—Ç–∞.'" class="text-xs text-left p-2 bg-gray-100 hover:bg-gray-200 rounded">üì∑ –ù–µ—á–µ—Ç–∫–æ–µ —Ñ–æ—Ç–æ</button>
                                <button type="button" @click="document.getElementById('notes').value = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.'" class="text-xs text-left p-2 bg-gray-100 hover:bg-gray-200 rounded">üìù –ù–µ–∫–æ—Ä—Ä. –¥–∞–Ω–Ω—ã–µ</button>
                                <button type="button" @click="document.getElementById('notes').value = '–ö–∞—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.'" class="text-xs text-left p-2 bg-gray-100 hover:bg-gray-200 rounded">üí≥ –ö–∞—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</button>
                                <button type="button" @click="document.getElementById('notes').value = '–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª.'" class="text-xs text-left p-2 bg-gray-100 hover:bg-gray-200 rounded">‚ö†Ô∏è –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª</button>
                            </div>
                        </div>

                        <div>
                            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-800 hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                <i class="fa-solid fa-save mr-2"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="bg-white shadow sm:rounded-lg">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <h3 class="text-lg leading-6 font-medium text-gray-900">
                    <i class="fa-solid fa-bolt mr-2 text-gray-500"></i>
                    –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
                </h3>
            </div>
            <div class="px-4 py-5 sm:p-6">
                <div class="space-y-3">
                    <button onclick="copyToClipboard('{{ participant.telegram_id }}')" class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        <i class="fa-solid fa-copy mr-2"></i>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å Telegram ID
                    </button>
                    <button onclick="copyToClipboard('{{ participant.phone_number }}')" class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        <i class="fa-solid fa-copy mr-2"></i>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            // You can add a small notification toast here if you want
            console.log('Copied:', text);
        }).catch(err => {
            console.error('Failed to copy: ', err);
        });
    }

    document.querySelector('form').addEventListener('submit', function(e) {
        const status = document.getElementById('status').value;
        const notes = document.getElementById('notes').value;
        const participantName = '{{ participant.full_name }}';
        
        let confirmMessage = `–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è ${participantName}?`;

        if (status === 'approved') {
            confirmMessage = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –û–î–û–ë–†–ò–¢–¨ –∑–∞—è–≤–∫—É ${participantName}?\n\n–£—á–∞—Å—Ç–Ω–∏–∫ –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram.`;
        } else if (status === 'rejected') {
            if (notes.trim() === '') {
                if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É –ë–ï–ó –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è? –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–∫–∞–∑–∞—Ç—å –ø—Ä–∏—á–∏–Ω—É.')) {
                    e.preventDefault();
                    return;
                }
            }
            confirmMessage = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –û–¢–ö–õ–û–ù–ò–¢–¨ –∑–∞—è–≤–∫—É ${participantName}?\n\n–£—á–∞—Å—Ç–Ω–∏–∫ –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º –≤ Telegram.`;
        }
        
        if (!confirm(confirmMessage)) {
            e.preventDefault();
        }
    });
</script>
{% endblock %}